{{ $path := printf "pki/issue/%s" (env "CLIENT_NAME") }}{{- with secret $path "common_name=localhost" -}}
  {{- if .Data.certificate -}}
  {{- .Data.certificate | writeToFile "/consul-template/config/certs/chain.crt" "consul-template" "consul-template" "0644" "newline" -}}
  {{- .Data.certificate }}
  {{- end -}}
  
  {{- if .Data.ca_chain -}}
  {{- range $key, $value := .Data.ca_chain -}}
    {{- $value | writeToFile "/consul-template/config/certs/chain.crt" "consul-template" "consul-template" "0644" "append" -}}

    {{- if eq $key 0 -}}
      {{- $value | writeToFile "/consul-template/config/certs/ca.crt" "consul-template" "consul-template" "0644" "newline" -}}
    {{- else -}}
      {{- $value | writeToFile "/consul-template/config/certs/ca.crt" "consul-template" "consul-template" "0644" "append" -}}
    {{- end -}}
  {{- end -}}
  {{- end -}}

  {{- if .Data.private_key -}}
  {{- .Data.private_key | writeToFile "/consul-template/config/certs/client.key" "consul-template" "consul-template" "0644" -}}
  {{- end -}}
{{- end -}}
