{{- with secret "pki/issue/kv-client" "common_name=localhost" -}}
  {{- if .Data.certificate -}}
  {{- .Data.certificate | writeToFile "certs/chain.crt" "vault" "vault" "0644" "newline" -}}
  {{- .Data.certificate }}
  {{- end -}}
  
  {{- if .Data.ca_chain -}}
  {{- range $key, $value := .Data.ca_chain -}}
    {{- $value | writeToFile "certs/chain.crt" "vault" "vault" "0644" "append" -}}

    {{- if eq $key 0 -}}
      {{- $value | writeToFile "certs/ca.crt" "vault" "vault" "0644" "newline" -}}
    {{- else -}}
      {{- $value | writeToFile "certs/ca.crt" "vault" "vault" "0644" "append" -}}
    {{- end -}}
  {{- end -}}
  {{- end -}}

  {{- if .Data.certificate -}}
  {{- .Data.certificate | writeToFile "certs/client.crt" "vault" "vault" "0644" -}}
  {{- .Data.certificate }}
  {{- end -}}

  {{- if .Data.private_key -}}
  {{- .Data.private_key | writeToFile "certs/client.key" "vault" "vault" "0644" -}}
  {{ .Data.private_key }}
  {{- end -}}
{{- end -}}
